<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piano Performance Test - Priority 1ä¿®æ­£æ¤œè¨¼</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        h1 {
            margin-top: 0;
            text-align: center;
            font-size: 2em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .test-section {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-section h2 {
            margin-top: 0;
            color: #ffd700;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            transition: transform 0.1s, box-shadow 0.1s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.3);
        }
        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .metrics {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
        }
        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .metric-row:last-child {
            border-bottom: none;
        }
        .metric-label {
            color: #ffd700;
        }
        .metric-value {
            font-weight: bold;
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-pass {
            background: #4ade80;
            color: #064e3b;
        }
        .status-fail {
            background: #f87171;
            color: #7f1d1d;
        }
        .status-pending {
            background: #fbbf24;
            color: #78350f;
        }
        #console-log {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            padding: 2px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .log-sync {
            color: #4ade80;
        }
        .log-load {
            color: #fbbf24;
        }
        .log-error {
            color: #f87171;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¹ Piano Performance Test</h1>
        <p style="text-align: center; font-size: 1.2em;">Priority 1ä¿®æ­£ã®æ¤œè¨¼: ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã®å³åº§å†ç”Ÿ</p>

        <div class="test-section">
            <h2>ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœ</h2>
            <div class="metrics">
                <div class="metric-row">
                    <span class="metric-label">ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰çŠ¶æ…‹:</span>
                    <span class="metric-value" id="preload-status">-</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">æœ€çµ‚æ¸¬å®šé…å»¶:</span>
                    <span class="metric-value" id="latency-result">-</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">å¹³å‡é…å»¶:</span>
                    <span class="metric-value" id="avg-latency">-</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">é‡è¤‡èª­ã¿è¾¼ã¿é˜²æ­¢:</span>
                    <span class="metric-value" id="dedup-status">-</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">ç·åˆè©•ä¾¡:</span>
                    <span class="metric-value" id="overall-status">-</span>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</h2>
            <button onclick="initTest()">1. éŸ³å£°ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–</button>
            <button onclick="preloadSamples()">2. ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰</button>
            <button onclick="testSingleNote()">3. å˜ä¸€éŸ³ãƒ†ã‚¹ãƒˆ</button>
            <button onclick="testRapidFire()">4. é€£æ‰“ãƒ†ã‚¹ãƒˆï¼ˆ10éŸ³ï¼‰</button>
            <button onclick="testDuplicateLoad()">5. é‡è¤‡èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ</button>
            <button onclick="clearResults()">çµæœã‚¯ãƒªã‚¢</button>
        </div>

        <div class="test-section">
            <h2>ğŸ“ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°</h2>
            <div id="console-log"></div>
        </div>
    </div>

    <script type="module">
        import { pianoKeyMapping } from '/src/utils/pianoTest.js';
        import unifiedAudioSystem from '/src/utils/unifiedAudioSystem.js';

        let audioSystem = unifiedAudioSystem;
        let latencyMeasurements = [];

        // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ãƒ•ãƒƒã‚¯
        const originalLog = console.log;
        const originalError = console.error;

        function addLogEntry(message, type = 'info') {
            const logDiv = document.getElementById('console-log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            const message = args.join(' ');
            if (message.includes('[SYNC_PLAY]')) {
                addLogEntry(message, 'sync');
            } else if (message.includes('[LOAD_OPTIMIZE]')) {
                addLogEntry(message, 'load');
            } else {
                addLogEntry(message, 'info');
            }
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addLogEntry(args.join(' '), 'error');
        };

        window.initTest = async function() {
            addLogEntry('ãƒ†ã‚¹ãƒˆåˆæœŸåŒ–é–‹å§‹...', 'info');

            await audioSystem.initialize();

            document.getElementById('preload-status').textContent = 'ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†';
            addLogEntry('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†', 'sync');
        };

        window.preloadSamples = async function() {
            if (!audioSystem.isInitialized) {
                alert('å…ˆã«éŸ³å£°ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ã—ã¦ãã ã•ã„');
                return;
            }

            addLogEntry('ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰é–‹å§‹...', 'info');

            // MIDI 60 (C4) ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰
            const keyInfo = pianoKeyMapping[60];
            const audioBuffer = await audioSystem.loadAudioFile(keyInfo.sample, true);

            if (audioBuffer) {
                document.getElementById('preload-status').innerHTML =
                    '<span class="status status-pass">ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰å®Œäº†</span>';
                addLogEntry(`MIDI 60 ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰å®Œäº†: ${keyInfo.sample}`, 'sync');
            } else {
                document.getElementById('preload-status').innerHTML =
                    '<span class="status status-fail">ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰å¤±æ•—</span>';
                addLogEntry('ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰å¤±æ•—', 'error');
            }
        };

        window.testSingleNote = async function() {
            if (!audioSystem.isInitialized) {
                alert('å…ˆã«éŸ³å£°ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ã—ã¦ãã ã•ã„');
                return;
            }

            addLogEntry('å˜ä¸€éŸ³ãƒ†ã‚¹ãƒˆé–‹å§‹...', 'info');

            const startTime = performance.now();
            const result = audioSystem.playPianoNoteSync(60, 0.8);
            const endTime = performance.now();

            const latency = endTime - startTime;
            latencyMeasurements.push(latency);

            const latencyText = `${latency.toFixed(2)}ms`;
            document.getElementById('latency-result').textContent = latencyText;

            if (result && result.cached) {
                document.getElementById('latency-result').innerHTML =
                    `${latencyText} <span class="status status-pass">ã‚­ãƒ£ãƒƒã‚·ãƒ¥HIT</span>`;
                addLogEntry(`é…å»¶: ${latencyText} (ã‚­ãƒ£ãƒƒã‚·ãƒ¥HIT)`, 'sync');
            } else {
                document.getElementById('latency-result').innerHTML =
                    `${latencyText} <span class="status status-pending">åˆå›èª­ã¿è¾¼ã¿</span>`;
                addLogEntry(`é…å»¶: ${latencyText} (åˆå›èª­ã¿è¾¼ã¿)`, 'load');
            }

            updateAverageLatency();
        };

        window.testRapidFire = async function() {
            if (!audioSystem.isInitialized) {
                alert('å…ˆã«éŸ³å£°ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ã—ã¦ãã ã•ã„');
                return;
            }

            addLogEntry('é€£æ‰“ãƒ†ã‚¹ãƒˆé–‹å§‹ï¼ˆ10éŸ³ï¼‰...', 'info');

            for (let i = 0; i < 10; i++) {
                const startTime = performance.now();
                audioSystem.playPianoNoteSync(60, 0.8);
                const endTime = performance.now();

                const latency = endTime - startTime;
                latencyMeasurements.push(latency);

                addLogEntry(`é€£æ‰“ ${i+1}/10: ${latency.toFixed(2)}ms`, 'sync');

                // 50mså¾…æ©Ÿ
                await new Promise(resolve => setTimeout(resolve, 50));
            }

            updateAverageLatency();
            addLogEntry('é€£æ‰“ãƒ†ã‚¹ãƒˆå®Œäº†', 'sync');
        };

        window.testDuplicateLoad = async function() {
            if (!audioSystem.isInitialized) {
                alert('å…ˆã«éŸ³å£°ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ã—ã¦ãã ã•ã„');
                return;
            }

            addLogEntry('é‡è¤‡èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆé–‹å§‹...', 'info');

            // æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«åã§ãƒ†ã‚¹ãƒˆï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«å­˜åœ¨ã—ãªã„ï¼‰
            const testFile = 'msSoundsMuseScore_General.sf3.flac.62.flac';

            // åŒæ™‚ã«3å›èª­ã¿è¾¼ã¿è¦æ±‚
            const promises = [
                audioSystem.loadAudioFile(testFile, true),
                audioSystem.loadAudioFile(testFile, true),
                audioSystem.loadAudioFile(testFile, true)
            ];

            const results = await Promise.all(promises);

            if (results.every(r => r !== null)) {
                document.getElementById('dedup-status').innerHTML =
                    '<span class="status status-pass">æ­£å¸¸å‹•ä½œ</span>';
                addLogEntry('é‡è¤‡èª­ã¿è¾¼ã¿é˜²æ­¢: æ­£å¸¸å‹•ä½œï¼ˆ1å›ã®fetchã§3ã¤ã®Promiseè§£æ±ºï¼‰', 'sync');
            } else {
                document.getElementById('dedup-status').innerHTML =
                    '<span class="status status-fail">å¤±æ•—</span>';
                addLogEntry('é‡è¤‡èª­ã¿è¾¼ã¿é˜²æ­¢: å¤±æ•—', 'error');
            }
        };

        function updateAverageLatency() {
            if (latencyMeasurements.length === 0) return;

            const avg = latencyMeasurements.reduce((a, b) => a + b, 0) / latencyMeasurements.length;
            const avgText = `${avg.toFixed(2)}ms (n=${latencyMeasurements.length})`;
            document.getElementById('avg-latency').textContent = avgText;

            // ç·åˆè©•ä¾¡
            if (avg < 10) {
                document.getElementById('overall-status').innerHTML =
                    '<span class="status status-pass">å„ªç§€ (<10ms)</span>';
            } else if (avg < 20) {
                document.getElementById('overall-status').innerHTML =
                    '<span class="status status-pass">è‰¯å¥½ (<20ms)</span>';
            } else if (avg < 50) {
                document.getElementById('overall-status').innerHTML =
                    '<span class="status status-pending">è¨±å®¹ç¯„å›² (<50ms)</span>';
            } else {
                document.getElementById('overall-status').innerHTML =
                    '<span class="status status-fail">è¦æ”¹å–„ (>50ms)</span>';
            }
        }

        window.clearResults = function() {
            latencyMeasurements = [];
            document.getElementById('latency-result').textContent = '-';
            document.getElementById('avg-latency').textContent = '-';
            document.getElementById('overall-status').textContent = '-';
            document.getElementById('console-log').innerHTML = '';
            addLogEntry('çµæœã‚¯ãƒªã‚¢å®Œäº†', 'info');
        };

        // åˆæœŸåŒ–
        addLogEntry('Performance Testæº–å‚™å®Œäº†', 'info');
        addLogEntry('ã€Œ1. éŸ³å£°ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã€ã‹ã‚‰é–‹å§‹ã—ã¦ãã ã•ã„', 'info');
    </script>
</body>
</html>
