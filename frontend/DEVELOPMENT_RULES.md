# DAWAI 開発サーバー管理ルール

## 🔴 必須ルール - 絶対に守ること

### 1. ポート5173固定・複数起動禁止

**ルール**: 開発サーバーは**必ずポート5173のみ**で動作させる

**理由**:
- URLの一貫性確保
- E2Eテストとの整合性維持
- 複数プロセスによるリソース競合回避

**技術実装**:
```javascript
// vite.config.js
server: {
  port: 5173,
  strictPort: true, // 競合時エラーで停止
}
```

### 2. 開発サーバー起動前チェック

**必須手順**:
```bash
# 1. 既存プロセス確認
netstat -ano | findstr :5173

# 2. プロセス存在時は停止
# Claude Code: KillShell で既存バックグラウンドプロセス停止

# 3. クリーンな状態で起動
cd DAWAI_server/frontend
npm run dev
```

### 3. 複数起動防止メカニズム

**vite.config.js設定**:
- `strictPort: true` - ポート競合時に自動切り替えせずエラー停止
- `port: 5173` - ポート固定
- `host: 'localhost'` - ホスト固定

**期待される動作**:
```
✅ 正常: 5173ポートが空いている → サーバー起動成功
❌ エラー: 5173ポートが使用中 → 「Port 5173 is already in use」でエラー停止
```

## 🟡 推奨プラクティス

### 1. Claude Code使用時の注意事項

**バックグラウンドプロセス管理**:
- `run_in_background: true`は必要最小限に使用
- セッション終了時は必ずプロセス状況確認
- 複数のBashコマンドを並行実行しない

**プロセス監視**:
```bash
# 定期的にプロセス状況確認
netstat -ano | findstr :517

# バックグラウンドプロセス一覧
# Claude Code: BashOutput で状況確認
```

### 2. 開発ワークフロー

**標準手順**:
1. **起動前**: 既存プロセス確認・停止
2. **起動**: 単一プロセスで`npm run dev`実行
3. **作業**: `http://localhost:5173`でアクセス
4. **終了**: プロセス完全停止確認

### 3. トラブルシューティング

**ポート競合が発生した場合**:
```bash
# 1. 使用中プロセス特定
netstat -ano | findstr :5173

# 2. プロセスID確認
# PIDを確認してプロセス停止

# 3. 再起動
npm run dev
```

**複数プロセスが起動してしまった場合**:
```bash
# 1. 全てのnode.exeプロセス停止
taskkill /F /IM node.exe

# 2. ポート確認
netstat -ano | findstr :517

# 3. クリーンな状態で再起動
npm run dev
```

## 📋 チェックリスト

### 開発開始時
- [ ] ポート5173が空いているか確認
- [ ] 既存の開発サーバープロセスを停止
- [ ] `npm run dev`で単一プロセス起動
- [ ] `http://localhost:5173`でアクセス確認

### 開発終了時
- [ ] 開発サーバープロセス停止
- [ ] バックグラウンドプロセス有無確認
- [ ] ポート5173が解放されているか確認

### トラブル発生時
- [ ] 複数プロセスが起動していないか確認
- [ ] 正しいポート（5173）にアクセスしているか確認
- [ ] ブラウザのキャッシュクリア
- [ ] E2Eテストが正しいポートを参照しているか確認

## 🚨 緊急対応

### 複数サーバー起動が検出された場合

**即座実行**:
1. 全プロセス停止: `taskkill /F /IM node.exe`
2. ポート確認: `netstat -ano | findstr :517`
3. vite.config.js確認: `strictPort: true`の設定
4. 単一プロセスで再起動: `npm run dev`
5. URL確認: `http://localhost:5173`のみ使用

### 設定ファイル破損の場合

**復旧手順**:
```bash
# vite.config.jsのバックアップから復元
git checkout HEAD -- vite.config.js

# または最新の正常設定を適用
```

---

## 📝 更新履歴

- **2025-10-12**: 初版作成 - ポート5173固定化・複数起動禁止ルール制定
- **設定変更**: vite.config.jsに`strictPort: true`追加

---

**重要**: このルールは**必須遵守事項**です。違反すると開発環境の不安定化やE2Eテスト失敗の原因となります。