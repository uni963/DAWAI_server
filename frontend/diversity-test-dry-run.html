<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¤šæ§˜æ€§æ©Ÿèƒ½ Dry Run ãƒ†ã‚¹ãƒˆ</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      background-color: #1e1e1e;
      color: #d4d4d4;
      padding: 20px;
    }
    h1 {
      color: #4ec9b0;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    .test-section {
      background-color: #252526;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      border: 1px solid #3c3c3c;
    }
    button {
      background-color: #0e639c;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    button:hover {
      background-color: #1177bb;
    }
    button:active {
      background-color: #0d5a8f;
    }
    .output {
      background-color: #1e1e1e;
      padding: 15px;
      border-radius: 4px;
      margin-top: 10px;
      border: 1px solid #3c3c3c;
      max-height: 400px;
      overflow-y: auto;
      font-size: 12px;
    }
    .log-line {
      margin: 2px 0;
      padding: 2px 0;
    }
    .log-line.info {
      color: #4ec9b0;
    }
    .log-line.warn {
      color: #ce9178;
    }
    .log-line.error {
      color: #f48771;
    }
    .log-line.success {
      color: #89d185;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    .stat-box {
      background-color: #1e1e1e;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #3c3c3c;
    }
    .stat-label {
      color: #858585;
      font-size: 11px;
    }
    .stat-value {
      color: #4ec9b0;
      font-size: 24px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ² å¤šæ§˜æ€§æ©Ÿèƒ½ Dry Run ãƒ†ã‚¹ãƒˆ</h1>

    <div class="test-section">
      <h2>ğŸ“‹ ãƒ†ã‚¹ãƒˆèª¬æ˜</h2>
      <p>
        ã“ã®Dry Runãƒ†ã‚¹ãƒˆã¯ã€ç¢ºç‡çš„é¸æŠãƒ­ã‚¸ãƒƒã‚¯ãŒæ­£ã—ãå‹•ä½œã—ã¦ã„ã‚‹ã‹ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚<br>
        å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ã›ãšã«ã€ãƒ­ã‚¸ãƒƒã‚¯ã®ã¿ã‚’å®Ÿè¡Œã—ã¦çµæœã‚’ç¢ºèªã§ãã¾ã™ã€‚
      </p>
    </div>

    <div class="test-section">
      <h2>ğŸ¯ ãƒ†ã‚¹ãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</h2>
      <button onclick="runTest(10)">10å›ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
      <button onclick="runTest(50)">50å›ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
      <button onclick="runTest(100)">100å›ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
      <button onclick="clearOutput()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
      <button onclick="resetMetrics()">ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <div class="test-section">
      <h2>ğŸ“Š çµ±è¨ˆ</h2>
      <div class="stats">
        <div class="stat-box">
          <div class="stat-label">ãƒ•ãƒ¬ãƒ¼ã‚ºé¸æŠ</div>
          <div class="stat-value" id="phrase-count">0</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Ghosté¸æŠ</div>
          <div class="stat-value" id="ghost-count">0</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">ãƒ•ãƒ¬ãƒ¼ã‚ºå‰²åˆ</div>
          <div class="stat-value" id="phrase-percentage">0%</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Ghostå‰²åˆ</div>
          <div class="stat-value" id="ghost-percentage">0%</div>
        </div>
      </div>
    </div>

    <div class="test-section">
      <h2>ğŸ“ å®Ÿè¡Œãƒ­ã‚°</h2>
      <div class="output" id="output"></div>
    </div>
  </div>

  <script>
    // å¤šæ§˜æ€§ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆEnhancedMidiEditor.jsxã¨åŒã˜æ§‹é€ ï¼‰
    const diversityMetrics = {
      phraseCount: 0,
      ghostCount: 0,
      consecutivePhraseCount: 0,
      consecutiveGhostCount: 0,
      lastSource: null
    };

    // é‡ã¿ä»˜ããƒ©ãƒ³ãƒ€ãƒ é¸æŠï¼ˆEnhancedMidiEditor.jsxã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    function weightedRandomSelect(items) {
      const totalWeight = items.reduce((sum, item) => sum + (item.weight || 1), 0);
      const randomValue = Math.random();
      let random = randomValue * totalWeight;

      log(`ğŸ² [WEIGHTED_RANDOM] Selection process: totalWeight=${totalWeight}, randomValue=${randomValue.toFixed(4)}`, 'info');

      for (const item of items) {
        random -= (item.weight || 1);
        const selected = random <= 0;
        log(`ğŸ² [WEIGHTED_RANDOM] Checking ${item.type}: random=${random.toFixed(4)} ${selected ? 'âœ… SELECTED' : 'âŒ continue'}`, 'info');
        if (selected) {
          return item;
        }
      }

      return items[0];
    }

    // ç¢ºç‡çš„é¸æŠãƒ­ã‚¸ãƒƒã‚¯ï¼ˆEnhancedMidiEditor.jsxã¨åŒã˜ï¼‰
    function simulateAcceptNextGhostNote() {
      log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
      log('ğŸ² [DIVERSITY_DEBUG] acceptNextGhostNote simulation started', 'info');

      // ä¸¡æ–¹ã®äºˆæ¸¬ãŒåˆ©ç”¨å¯èƒ½ã¨ä»®å®š
      const hasPhraseNotes = true;
      const hasGhostPredictions = true;

      log(`ğŸ” [DIVERSITY_DEBUG] Availability: hasPhraseNotes=${hasPhraseNotes}, hasGhostPredictions=${hasGhostPredictions}`, 'info');

      let selectedType = null;

      if (hasPhraseNotes && hasGhostPredictions) {
        log(`ğŸ“Š [DIVERSITY_DEBUG] Current metrics: phraseCount=${diversityMetrics.phraseCount}, ghostCount=${diversityMetrics.ghostCount}, consecutivePhrase=${diversityMetrics.consecutivePhraseCount}, consecutiveGhost=${diversityMetrics.consecutiveGhostCount}`, 'info');

        // å‹•çš„ç¢ºç‡èª¿æ•´
        let phraseWeight = 0.6;
        let ghostWeight = 0.4;

        if (diversityMetrics.consecutivePhraseCount >= 3) {
          phraseWeight = 0.3;
          ghostWeight = 0.7;
          log(`ğŸ² [DIVERSITY_DEBUG] Diversity boost: Reducing phrase weight (consecutive=${diversityMetrics.consecutivePhraseCount})`, 'warn');
        } else if (diversityMetrics.consecutiveGhostCount >= 3) {
          phraseWeight = 0.7;
          ghostWeight = 0.3;
          log(`ğŸ² [DIVERSITY_DEBUG] Diversity boost: Reducing ghost weight (consecutive=${diversityMetrics.consecutiveGhostCount})`, 'warn');
        }

        const predictionTypes = [
          { type: 'phrase', weight: phraseWeight },
          { type: 'ghost', weight: ghostWeight }
        ];

        selectedType = weightedRandomSelect(predictionTypes).type;
        log(`ğŸ² [DIVERSITY_DEBUG] Selection result: ${selectedType} (weights: phrase=${phraseWeight}, ghost=${ghostWeight})`, 'success');
      }

      // ãƒ¡ãƒˆãƒªã‚¯ã‚¹æ›´æ–°
      if (selectedType === 'phrase') {
        diversityMetrics.phraseCount++;
        diversityMetrics.consecutivePhraseCount++;
        diversityMetrics.consecutiveGhostCount = 0;
        diversityMetrics.lastSource = 'phrase';
        log('âœ… [DIVERSITY_DEBUG] Phrase note accepted', 'success');
      } else {
        diversityMetrics.ghostCount++;
        diversityMetrics.consecutiveGhostCount++;
        diversityMetrics.consecutivePhraseCount = 0;
        diversityMetrics.lastSource = 'ghost';
        log('âœ… [DIVERSITY_DEBUG] Ghost note accepted', 'success');
      }

      const totalCount = diversityMetrics.phraseCount + diversityMetrics.ghostCount;
      log(`ğŸ“Š [DIVERSITY_DEBUG] Total count: ${totalCount}`, 'info');

      // 10å›ã”ã¨ã®çµ±è¨ˆ
      if (totalCount > 0 && totalCount % 10 === 0) {
        const phrasePercentage = ((diversityMetrics.phraseCount / totalCount) * 100).toFixed(1);
        const ghostPercentage = ((diversityMetrics.ghostCount / totalCount) * 100).toFixed(1);
        log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'success');
        log(`ğŸ“Š [DIVERSITY_STATS] 10å›ã”ã¨ã®çµ±è¨ˆãƒ¬ãƒãƒ¼ãƒˆ:`, 'success');
        log(`   Phrase: ${phrasePercentage}% (${diversityMetrics.phraseCount}å›)`, 'success');
        log(`   Ghost: ${ghostPercentage}% (${diversityMetrics.ghostCount}å›)`, 'success');
        log(`   Total: ${totalCount}å›`, 'success');
        log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'success');

        const samePatternRate = Math.max(diversityMetrics.consecutivePhraseCount, diversityMetrics.consecutiveGhostCount) / totalCount;
        if (samePatternRate > 0.2) {
          log('âš ï¸ [DIVERSITY_WARNING] é«˜ã„ç¹°ã‚Šè¿”ã—ç‡ã‚’æ¤œå‡º:', 'warn');
          log(`   ç¹°ã‚Šè¿”ã—ç‡: ${(samePatternRate * 100).toFixed(1)}%`, 'warn');
        }
      }

      log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');

      updateStats();
    }

    function runTest(iterations) {
      log(`\nğŸš€ ãƒ†ã‚¹ãƒˆé–‹å§‹: ${iterations}å›å®Ÿè¡Œ\n`, 'info');
      for (let i = 0; i < iterations; i++) {
        simulateAcceptNextGhostNote();
      }
      log(`\nâœ… ãƒ†ã‚¹ãƒˆå®Œäº†: ${iterations}å›å®Ÿè¡Œå®Œäº†\n`, 'success');
    }

    function updateStats() {
      const totalCount = diversityMetrics.phraseCount + diversityMetrics.ghostCount;
      const phrasePercentage = totalCount > 0 ? ((diversityMetrics.phraseCount / totalCount) * 100).toFixed(1) : 0;
      const ghostPercentage = totalCount > 0 ? ((diversityMetrics.ghostCount / totalCount) * 100).toFixed(1) : 0;

      document.getElementById('phrase-count').textContent = diversityMetrics.phraseCount;
      document.getElementById('ghost-count').textContent = diversityMetrics.ghostCount;
      document.getElementById('phrase-percentage').textContent = phrasePercentage + '%';
      document.getElementById('ghost-percentage').textContent = ghostPercentage + '%';
    }

    function resetMetrics() {
      diversityMetrics.phraseCount = 0;
      diversityMetrics.ghostCount = 0;
      diversityMetrics.consecutivePhraseCount = 0;
      diversityMetrics.consecutiveGhostCount = 0;
      diversityMetrics.lastSource = null;
      updateStats();
      log('ğŸ”„ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ', 'info');
    }

    function log(message, type = 'info') {
      const output = document.getElementById('output');
      const line = document.createElement('div');
      line.className = `log-line ${type}`;
      line.textContent = message;
      output.appendChild(line);
      output.scrollTop = output.scrollHeight;
    }

    function clearOutput() {
      document.getElementById('output').innerHTML = '';
    }

    // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    log('ğŸ² å¤šæ§˜æ€§æ©Ÿèƒ½ Dry Run ãƒ†ã‚¹ãƒˆ - æº–å‚™å®Œäº†', 'success');
    log('ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç¢ºç‡çš„é¸æŠãƒ­ã‚¸ãƒƒã‚¯ã‚’æ¤œè¨¼ã—ã¦ãã ã•ã„', 'info');
  </script>
</body>
</html>
