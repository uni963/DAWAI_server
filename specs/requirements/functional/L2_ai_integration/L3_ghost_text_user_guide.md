# Ghost Text補完機能 - ユーザーガイド (L3)

**Document ID**: FR-L3-GT-USER-001
**Version**: 1.0.0
**Last Updated**: 2025-10-12
**Parent**: [L2: AI統合機能要件](./index.md)
**Implementation Status**: ✅ Implemented

## 🎯 概要

Ghost Text補完機能は、AIを使ってMIDI入力を予測し、次に入力する音符を半透明のノート（ゴーストノート）として表示する機能です。音楽理論に基づいた智能的な予測により、初心者でも自然な音楽フレーズを作成できます。

## 🚀 基本的な使い方

### 1. Ghost Text機能の有効化

#### 設定方法
1. **設定モーダルを開く**: 画面右上の歯車アイコンをクリック
2. **MIDIエディタタブを選択**: 設定モーダル内の「MIDI Editor」タブを選択
3. **Ghost Textを有効化**: 「Ghost Text有効化」のチェックボックスをONにする
4. **AIモデルを選択**: 使用するAIモデルを選択
   - **Magenta (推奨)**: Google Magentaの音楽生成モデル
   - **Phi-2**: 高速な予測エンジン（要約ボタンでの手動更新が必要）
   - **無効**: Ghost Text機能を使用しない

### 2. 予測の表示

MIDIエディタでノートを入力すると、自動的に次のノートの予測が**半透明の点滅するノート**として表示されます。

#### 点滅効果について
**これは仕様です！** 点滅は承認待ちのGhost Textノートを視覚的に強調するための意図的なデザインです。

- **実装詳細**: `MidiEditorCanvas.jsx:689-691`
```javascript
// 承認待ちのノートに目立つ点滅効果を追加
const time = Date.now() / 1000
const alpha = 0.3 + 0.4 * Math.sin(time * 3) // より目立つ点滅効果
```

**デザイン意図**:
- ユーザーの注意を引き、予測されたノートの存在を明確に示す
- 通常のノートと区別し、「これは確定されていない提案」であることを視覚的に伝える
- 承認待ち状態を動的に表現することで、インタラクティブな体験を提供

## ⌨️ キーボードショートカット

### Tab キーの使い方

Ghost Text機能では、**Tabキー**が予測の受け入れに使用されます。

#### 基本操作
- **Tab**: すべてのGhost Text予測を一括受け入れ
  - 表示されているすべての予測ノートを確定してMIDIトラックに追加
  - 予測がクリアされ、新しい予測が生成される

- **Shift+Tab**: 前の予測を選択（複数予測がある場合）
  - 複数の予測候補がある場合、選択中の予測を前の候補に切り替え
  - 予測候補を順番に確認できる

#### 実装場所
- **MidiEditorCanvas.jsx:1210-1230**: キーボードイベントハンドラー
- **useGhostText.js:325-358**: 予測受け入れロジック

```javascript
// Tabキーで予測を受け入れる
if (e.key === 'Tab' && ghostPredictions.length > 0) {
  e.preventDefault()

  if (e.shiftKey) {
    // Shift+Tab: 前の予測を選択
    const newIndex = (state.selectedPredictionIndex - 1 + ghostPredictions.length) % ghostPredictions.length
    state.setSelectedPredictionIndex(newIndex)
  } else {
    // Tab: 全予測を受け入れる
    if (onAcceptAllPredictions) {
      onAcceptAllPredictions()
    }
    state.setSelectedPredictionIndex(0)
  }
}
```

## 🎼 音楽理論統合

### ジャンルとスケールの設定

Ghost Text機能は、選択したジャンルとスケールに基づいて予測を生成します。

#### サポート対象ジャンル
- **ポップミュージック調**: 明るく親しみやすいメロディー
- **ジャズ調**: 複雑なコード進行とスウィング感
- **R&B調**: ソウルフルでなめらかなフレーズ
- **ロック調**: 力強くストレートなリフ
- **バラード調**: 感情的で叙情的なメロディー

#### サポート対象スケール
- **メジャースケール**: 明るく安定した響き
- **マイナースケール**: 暗く哀愁のある響き
- **ペンタトニックスケール**: シンプルで普遍的な響き
- **ブルーノートスケール**: ブルージーで個性的な響き

#### 設定方法
1. **設定モーダル**を開く
2. **Ghost Text設定セクション**を見つける
3. **ジャンル**を選択
4. **スケール**を選択（複数選択可能）
5. **ルート音**と**オクターブ**を設定

### 音楽理論フィルタリング

Ghost Textは、選択したスケールに基づいて予測をフィルタリングします：

- **スケール内音程**: 常に優先的に提案
- **経過音**: 設定により許可可能
- **ジャンル特性**: 選択したジャンルに応じたスコアリング

詳細は [L3_ghost_text_enhancement.md](./L3_ghost_text_enhancement.md) を参照してください。

## 🎛️ 詳細設定

### MIDIエディタ設定パネル

各MIDIトラックの設定パネルから、以下の項目を調整できます：

#### AIモデル選択
- **Disabled (無効)**: Ghost Text機能を使用しない
- **Magenta (従来)**: Google Magentaモデル（自動予測）
- **Phi-2 (高速)**: 高速予測エンジン（要約ボタン方式）

#### 予測設定（Magentaモデルの場合）
- **予測閾値** (Prediction Threshold): 予測の信頼度閾値 (0.0-1.0)
  - 高い値: より確実な予測のみ表示
  - 低い値: より多くの予測を表示

- **デバウンス遅延** (Debounce Delay): 入力後の予測生成遅延時間 (ms)
  - 短い値: 即座に予測表示（CPU負荷高）
  - 長い値: 遅延後に予測表示（CPU負荷低）

- **コンテキストウィンドウ** (Context Window): 予測に使用する過去のノート数
  - 大きい値: より長期的なパターンを考慮
  - 小さい値: より直近のパターンに焦点

- **表示予測数** (Display Count): 画面に表示する予測の数
  - 1: 最も可能性の高い予測のみ
  - 複数: 複数の候補を表示

#### 要約管理（Phi-2モデルの場合）
- **「要約を更新」ボタン**: 現在のトラック内容を要約してAIに送信
- **Last Updated**: 最後に要約を更新した日時
- **Summary Status**: 要約の状態
  - ✓ Ready: 要約が最新
  - ⚠ Needs Update: 要約の更新が推奨される

## 💡 使用のヒント

### 初心者向けのベストプラクティス

1. **まずはデフォルト設定で試す**
   - デフォルト設定（ポップ調・メジャースケール）は初心者に最適
   - 慣れてきたらジャンルやスケールを変更

2. **Tabキーを活用**
   - 予測が気に入ったらすぐにTabキーで受け入れ
   - 複数の予測がある場合はShift+Tabで選択

3. **ジャンルとスケールを変更して実験**
   - 異なるジャンル・スケールで同じメロディーを試してみる
   - 音楽理論を実践的に学べる

4. **予測を参考にしながら独自のアレンジ**
   - Ghost Textの予測はあくまで提案
   - 自分の感性で自由に変更・調整してOK

### 中級者向けのテクニック

1. **コンテキストウィンドウを調整**
   - 長いフレーズを作る場合: 大きい値（16-32）
   - 短いモチーフを作る場合: 小さい値（4-8）

2. **複数スケールの組み合わせ**
   - メジャー＋ペンタトニック: 明るくシンプル
   - マイナー＋ブルーノート: 個性的で深みのある響き

3. **ジャンル特性を活用**
   - ジャズ: テンションノートや複雑なリズム
   - ポップ: 親しみやすいメロディーライン
   - ロック: 力強いリフとシンプルな構造

## 🔧 トラブルシューティング

### よくある問題と解決方法

#### Q1: Ghost Textが表示されない
**確認事項**:
1. Ghost Text機能が有効になっているか
2. AIモデルが選択されているか
3. 十分なノートが入力されているか（最低4-8ノート推奨）
4. ブラウザコンソールにエラーが表示されていないか

#### Q2: 予測が遅い
**対処方法**:
1. デバウンス遅延を長くする（200-500ms）
2. コンテキストウィンドウを小さくする（8-16）
3. 表示予測数を減らす（1-2個）
4. Phi-2モデルに切り替える（高速）

#### Q3: 予測が音楽的に不自然
**対処方法**:
1. ジャンルとスケールの設定を確認
2. 予測閾値を上げる（0.7-0.9）
3. より多くのコンテキスト（既存ノート）を入力
4. 異なるジャンル・スケールを試す

#### Q4: Tabキーが反応しない
**確認事項**:
1. MIDIエディタにフォーカスがあるか
2. Ghost Text予測が表示されているか
3. タブナビゲーション要素にフォーカスしていないか
4. ブラウザコンソールで警告を確認

## 📊 パフォーマンスメトリクス

### Ghost Textパネル

画面右側のGhost Textパネルには、以下の情報が表示されます：

- **現在のモデル**: 使用中のAIモデル
- **モデル状態**: 初期化済み/読み込み中/エラー
- **平均予測時間**: 予測生成にかかる平均時間（ms）
- **キャッシュヒット率**: キャッシュから予測を取得できた割合（%）
- **総予測回数**: 起動後の総予測生成回数

### パフォーマンス目標

| 指標 | 目標値 | 許容値 |
|------|--------|--------|
| 予測応答時間 | <300ms | <1000ms |
| システム初期化 | <5秒 | <10秒 |
| メモリ使用量 | <100MB | <200MB |
| CPU使用率（アイドル） | <10% | <20% |

## 🔗 関連ドキュメント

### 技術仕様
- **[L3: Ghost Text拡張機能仕様](./L3_ghost_text_enhancement.md)** - ジャンル・スケール対応の詳細仕様
- **[L2: AI統合機能要件](./index.md)** - AI統合システム全体の仕様

### 実装ファイル
- **フロントエンド**:
  - `frontend/src/hooks/useGhostText.js` - Ghost Text機能のReactフック
  - `frontend/src/utils/magentaGhostTextEngine.js` - Magentaモデル統合
  - `frontend/src/utils/ghostText/` - Ghost Textシステム全体
  - `frontend/src/components/GhostTextPanel.jsx` - Ghost Text設定パネル
  - `frontend/src/components/MIDIEditor/` - MIDIエディタ統合

- **バックエンド**:
  - `backend/ai_agent/main.py` - AI統合API
  - `backend/ghost_text/` - Ghost Textサービス（Phi-2モデル）

### テスト
- **E2Eテスト**: `frontend/tests/e2e/ghost-text-genre-scale.spec.js`

## 📝 更新履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|----------|
| 1.0.0 | 2025-10-12 | 初版作成 - Tabキー動作とUI仕様のドキュメント化 |

---

**実装完了日**: 2024年12月
**最終更新**: 2025年10月12日
**ドキュメント作成者**: Claude Code
