# DAWAI 階層型仕様書2.0 - ID体系マッピング
version: 2.0.0
last_updated: 2025-01-22
project: DAWAI

# ID命名規則
id_system:
  functional_requirements:
    prefix: FR
    format: "FR-[DOMAIN]-[XXX]"
    domains: [AUDIO, AI, PROJECT, UI]
    example: "FR-AUDIO-001"
    description: "機能要件識別子"

  non_functional_requirements:
    prefix: NFR
    format: "NFR-[CATEGORY]-[XXX]"
    categories: [PERF, SEC, REL, USABILITY]
    example: "NFR-PERF-001"
    description: "非機能要件識別子"

  logical_architecture:
    prefix: LA
    format: "LA-L[LEVEL]-[COMPONENT]-[XXX]"
    levels: [1, 2, 3]
    components: [SYSTEM, FRONTEND, BACKEND, AI, AUDIO]
    example: "LA-L2-FRONTEND-001"
    description: "論理アーキテクチャコンポーネント"

  physical_architecture:
    prefix: PA
    format: "PA-L[LEVEL]-[RESOURCE]-[XXX]"
    levels: [1, 2, 3]
    resources: [DEPLOY, NETWORK, STORAGE, COMPUTE]
    example: "PA-L1-DEPLOY-001"
    description: "物理アーキテクチャリソース"

  design_documents:
    prefix: DG
    format: "DG-[TYPE]-L[LEVEL]-[NAME]"
    types: [SEQ, FLOW, STATE, CLASS, ER, DEPLOY]
    example: "DG-SEQ-L2-CHAT"
    description: "設計ダイアグラム"

  test_cases:
    prefix: TC
    format: "TC-[TYPE]-[XXX]"
    types: [FUNC, PERF, SEC, INT, E2E]
    example: "TC-FUNC-001"
    description: "テストケース"

  documents:
    prefix: DOC
    format: "DOC-L[LEVEL]-[TYPE]-[XXX]"
    types: [OVERVIEW, BUSINESS, ARCH, REQ, DESIGN]
    example: "DOC-L0-OVERVIEW-001"
    description: "ドキュメント"

# 機能要件ID定義
functional_requirements:
  # 音声・MIDI処理機能
  FR-AUDIO-001:
    title: "リアルタイム音声処理エンジン"
    description: "Tone.js基盤の低遅延音声合成・処理"
    implementation: "frontend/src/utils/unifiedAudioSystem.js"
    status: "implemented"
    priority: "critical"

  FR-AUDIO-002:
    title: "MIDI編集機能"
    description: "ピアノロール形式でのMIDI編集"
    implementation: "frontend/src/components/EnhancedMidiEditor.jsx"
    status: "implemented"
    priority: "critical"

  FR-AUDIO-003:
    title: "マルチトラック管理"
    description: "複数トラックの同期再生・ミキシング"
    implementation: "frontend/src/components/ArrangementView.jsx"
    status: "implemented"
    priority: "high"

  FR-AUDIO-004:
    title: "ドラムシーケンサー"
    description: "グリッドベースドラムパターン作成"
    implementation: "frontend/src/components/DrumTrack/"
    status: "implemented"
    priority: "high"

  FR-AUDIO-005:
    title: "重低音ベーストラック"
    description: "重低音域（C1-G2）専用ベースライン制作"
    implementation: "frontend/src/data/sampleData.js"
    status: "implemented"
    priority: "high"

  # AI統合機能
  FR-AI-001:
    title: "対話型音楽制作アシスタント"
    description: "マルチAI対応チャットアシスタント"
    implementation: "frontend/src/components/AIassistant/, backend/ai_agent/main.py"
    status: "implemented"
    priority: "critical"

  FR-AI-002:
    title: "AI歌声合成 (DiffSinger)"
    description: "歌詞からリアルな歌声生成"
    implementation: "backend/diffsinger/, frontend/src/components/DiffSingerTrack.jsx"
    status: "implemented"
    priority: "high"

  FR-AI-002-OPT:
    title: "DiffSinger統合最適化"
    description: "プラグインアーキテクチャによる多言語対応基盤"
    implementation: "backend/diffsinger/diffsinger_engine/core/base_synthesis_engine.py"
    status: "optimized"
    priority: "high"
    parent: "FR-AI-002"

  FR-AI-002-A:
    title: "中国語エンジンプラグイン化"
    description: "基底クラスを継承した中国語特化エンジン"
    implementation: "backend/diffsinger/diffsinger_engine/languages/zh_CN/chinese_engine.py"
    status: "implemented"
    priority: "high"
    parent: "FR-AI-002-OPT"

  FR-AI-002-B:
    title: "日本語エンジン基盤構築"
    description: "日本語対応のための基盤実装"
    implementation: "backend/diffsinger/diffsinger_engine/languages/ja_JP/japanese_engine.py"
    status: "foundation"
    priority: "medium"
    parent: "FR-AI-002-OPT"

  FR-AI-003:
    title: "テキスト補完 (Ghost Text)"
    description: "歌詞・楽譜入力時のAI支援"
    implementation: "backend/ghost_text/, frontend/src/components/GhostTextPanel.jsx"
    status: "implemented"
    priority: "medium"

  FR-AI-004:
    title: "マルチAI切り替え・統合"
    description: "Claude/OpenAI/Gemini統合管理"
    implementation: "backend/ai_agent/main.py, frontend/src/components/AIassistant/ModelSelector.jsx"
    status: "implemented"
    priority: "high"

  # プロジェクト管理機能
  FR-PROJECT-001:
    title: "楽曲プロジェクト管理"
    description: "プロジェクト作成・保存・読み込み"
    implementation: "frontend/src/components/ProjectMenu.jsx"
    status: "implemented"
    priority: "high"

  FR-PROJECT-002:
    title: "セッション永続化"
    description: "作業状態の自動保存・復元"
    implementation: "frontend/src/hooks/useMidiPersistence.js"
    status: "implemented"
    priority: "medium"

  FR-PROJECT-003:
    title: "インポート・エクスポート"
    description: "MIDI/WAV/プロジェクトファイル入出力"
    implementation: "frontend/src/utils/audioExportEngine.js"
    status: "implemented"
    priority: "high"

  # UI機能
  FR-UI-001:
    title: "レスポンシブWebアプリケーション"
    description: "デスクトップ・タブレット対応UI"
    implementation: "frontend/src/App.jsx, Tailwind CSS"
    status: "implemented"
    priority: "critical"

  FR-UI-002:
    title: "リアルタイムビジュアライゼーション"
    description: "波形・スペクトラム・MIDI可視化"
    implementation: "frontend/src/components/MIDIEditor/MidiEditorCanvas.jsx"
    status: "implemented"
    priority: "high"

  FR-UI-003:
    title: "キーボードショートカット"
    description: "効率的操作のためのキーボード対応"
    implementation: "frontend/src/components/ArrangementView/hooks/useKeyboardShortcuts.js"
    status: "implemented"
    priority: "medium"

  FR-UI-004:
    title: "設定・カスタマイズ"
    description: "ユーザー設定・テーマ・言語切り替え"
    implementation: "frontend/src/components/SettingsModal.jsx"
    status: "implemented"
    priority: "medium"

  # 音楽制作サポート機能
  FR-GENRE-001:
    title: "ジャンル別音楽制作システム"
    description: "ジャンル別スケール制約・コード進行・楽器推奨"
    implementation: "frontend/src/managers/genreManager.js, frontend/src/components/GenreSelector.jsx"
    status: "implemented"
    priority: "high"

  FR-THEORY-001:
    title: "スケール制約システム"
    description: "autoSetOnLoad機能によるスケール制約自動適用"
    implementation: "frontend/src/utils/MusicTheoryEngine.js"
    status: "implemented"
    priority: "high"

  FR-THEORY-002:
    title: "コード進行システム"
    description: "ジャンル別定番コード進行提供"
    implementation: "frontend/src/data/musicTheory.js"
    status: "implemented"
    priority: "medium"

# 非機能要件ID定義
non_functional_requirements:
  NFR-PERF-001:
    title: "音声遅延性能"
    requirement: "音声入力から出力まで50ms以下"
    measurement: "Round-trip latency測定"
    current_value: "~30ms"
    status: "achieved"

  NFR-PERF-002:
    title: "AI応答性能"
    requirement: "AI応答開始3秒以内"
    measurement: "API応答時間測定"
    current_value: "~2秒"
    status: "achieved"

  NFR-PERF-003:
    title: "メモリ使用量"
    requirement: "512MB以下の使用量"
    measurement: "Performance API監視"
    current_value: "~300MB"
    status: "achieved"

  NFR-SEC-001:
    title: "API認証セキュリティ"
    requirement: "外部APIキーの安全な管理"
    implementation: "環境変数による管理"
    status: "partial" # 改善必要

  NFR-SEC-002:
    title: "CORS設定セキュリティ"
    requirement: "適切なオリジン制限"
    current_issue: "allow_origins=['*']設定"
    status: "needs_improvement"

  NFR-REL-001:
    title: "システム可用性"
    requirement: "99.5%稼働率"
    measurement: "アップタイム監視"
    status: "target"

  NFR-USABILITY-001:
    title: "ブラウザ対応"
    requirement: "Chrome90+, Firefox88+, Safari14+対応"
    current_support: "Chrome, Firefox, Edge (full), Safari (partial)"
    status: "achieved"

# アーキテクチャID定義
logical_architecture:
  LA-L1-SYSTEM-001:
    title: "システム全体アーキテクチャ"
    description: "React + FastAPI システム構成"
    document: "architecture/logical/L1_system.md"
    requirements: [FR-AUDIO-001, FR-AI-001, FR-PROJECT-001, FR-UI-001]

  LA-L2-FRONTEND-001:
    title: "React フロントエンド構成"
    description: "コンポーネント階層とデータフロー"
    parent: "LA-L1-SYSTEM-001"
    implementation: "frontend/src/"

  LA-L2-BACKEND-001:
    title: "FastAPI バックエンド構成"
    description: "API層とサービス層構成"
    parent: "LA-L1-SYSTEM-001"
    implementation: "backend/"

  LA-L3-AUDIO-001:
    title: "音声処理コンポーネント群"
    description: "Tone.js統合音声システム"
    parent: "LA-L2-FRONTEND-001"
    implementation: "frontend/src/utils/unifiedAudioSystem.js"

  LA-L3-AI-001:
    title: "AI統合コンポーネント群"
    description: "マルチAI統合システム"
    parent: "LA-L2-BACKEND-001"
    implementation: "backend/ai_agent/"

# 設計ドキュメントID定義
design_documents:
  DG-ARCH-L1-SYSTEM:
    title: "システム全体構成図"
    type: "architecture_diagram"
    location: "architecture/logical/L1_system.md"
    mermaid_type: "graph TB"

  DG-SEQ-L1-DATAFLOW:
    title: "主要データフロー"
    type: "sequence_diagram"
    location: "architecture/logical/L1_system.md"
    mermaid_type: "sequenceDiagram"

  DG-MIND-L1-REQUIREMENTS:
    title: "機能要件マップ"
    type: "mindmap"
    location: "requirements/functional/L1_index.md"
    mermaid_type: "mindmap"

# テストケースID定義
test_cases:
  TC-FUNC-001:
    title: "音声再生基本機能テスト"
    requirement: "FR-AUDIO-001"
    type: "functional"
    priority: "critical"

  TC-FUNC-002:
    title: "MIDI編集機能テスト"
    requirement: "FR-AUDIO-002"
    type: "functional"
    priority: "critical"

  TC-PERF-001:
    title: "音声遅延性能テスト"
    requirement: "NFR-PERF-001"
    type: "performance"
    priority: "high"

  TC-SEC-001:
    title: "API認証セキュリティテスト"
    requirement: "NFR-SEC-001"
    type: "security"
    priority: "high"

# トレーサビリティマッピング
traceability:
  # 音声機能のトレーサビリティ
  FR-AUDIO-001:
    architecture: [LA-L1-SYSTEM-001, LA-L2-FRONTEND-001, LA-L3-AUDIO-001]
    design: [DG-ARCH-L1-SYSTEM, DG-SEQ-L1-DATAFLOW]
    implementation: ["frontend/src/utils/unifiedAudioSystem.js"]
    tests: [TC-FUNC-001, TC-PERF-001]

  FR-AUDIO-002:
    architecture: [LA-L2-FRONTEND-001, LA-L3-AUDIO-001]
    design: [DG-ARCH-L1-SYSTEM]
    implementation: ["frontend/src/components/EnhancedMidiEditor.jsx"]
    tests: [TC-FUNC-002]

  # AI機能のトレーサビリティ
  FR-AI-001:
    architecture: [LA-L1-SYSTEM-001, LA-L2-BACKEND-001, LA-L3-AI-001]
    design: [DG-ARCH-L1-SYSTEM, DG-SEQ-L1-DATAFLOW]
    implementation: ["backend/ai_agent/main.py", "frontend/src/components/AIassistant/"]
    tests: [TC-FUNC-003]

  # セキュリティ要件のトレーサビリティ
  NFR-SEC-001:
    architecture: [LA-L2-BACKEND-001]
    implementation: ["backend/ai_agent/main.py"]
    tests: [TC-SEC-001]

# 実装同期ステータス
implementation_sync:
  last_sync_check: "2025-01-22T10:00:00Z"
  sync_method: "manual_verification"

  verified_mappings:
    - id: "FR-AUDIO-001"
      file: "frontend/src/utils/unifiedAudioSystem.js"
      status: "✅ verified"
      last_check: "2025-01-22"

    - id: "FR-AI-001"
      file: "backend/ai_agent/main.py"
      status: "✅ verified"
      last_check: "2025-01-22"

  pending_verification:
    - id: "LA-L2-FRONTEND-001"
      reason: "detailed_documentation_pending"

    - id: "LA-L2-BACKEND-001"
      reason: "detailed_documentation_pending"

  refactoring_mappings:
    # PR #6 リファクタリング実装マッピング (2025-10-11)
    - id: "DC-L3-APP-STRUCTURE-002"
      description: "App.jsx Manager Classes パターン実装"
      files:
        - "frontend/src/classes/ProjectManager.js"
        - "frontend/src/classes/EventHandlersManager.js"
        - "frontend/src/classes/AppSettingsManager.js"
      status: "✅ implemented"

    - id: "DC-L3-ARRANGEMENT-MODULE"
      description: "ArrangementView モジュール化"
      files:
        - "frontend/src/components/ArrangementView/hooks/*.js"
        - "frontend/src/components/ArrangementView/components/*.jsx"
      status: "✅ implemented"

    - id: "DC-L3-AI-ASSISTANT-MODULE"
      description: "AIAssistant コンポーネント再構成"
      files:
        - "frontend/src/components/AIassistant/*.jsx"
      status: "✅ implemented"

    - id: "DC-L3-DRUM-TRACK-MODULE"
      description: "DrumTrack モジュール再構築"
      files:
        - "frontend/src/components/DrumTrack/hooks/*.js"
        - "frontend/src/components/DrumTrack/*.jsx"
      status: "✅ implemented"

# メタデータ
metadata:
  total_requirements: 20
  implemented_requirements: 20
  implementation_rate: "100%"

  critical_requirements: 4
  high_requirements: 10
  medium_requirements: 6

  last_major_update: "2025-10-11"
  next_review_date: "2025-11-10"

  refactoring_status:
    pr_6_completed: true
    completion_date: "2025-10-11"
    pr_reference: "#6 - refactor/app-component-extraction"
    key_achievements:
      - "Manager Classes パターン導入 (3クラス)"
      - "ArrangementView モジュール化 (7 hooks + 7 components)"
      - "AIAssistant 再構成 (10 ファイル分離)"
      - "DrumTrack 再構築 (4 hooks + 5 components)"
      - "コード品質向上・保守性改善"