# ドラムトラックデータ構造の設計

## 概要

Melodia Composer Copilotのドラムトラック機能のために、新しい統合データ構造を設計しました。このデータ構造は既存のMIDIデータ構造と互換性を持ち、他のコンポーネントと連携できるように設計されています。

## 1. データ構造の特徴

### 1.1 統合性
- 既存のMIDIデータ構造と互換性を保持
- ProjectManagerとの連携を考慮した設計
- 他のコンポーネント（ArrangementView、Mixer等）との統合

### 1.2 拡張性
- パターン管理機能
- プリセットパターンのサポート
- イベント駆動型の設計

### 1.3 パフォーマンス
- 効率的なデータ更新
- メモリ使用量の最適化
- リアルタイム処理に対応

## 2. 主要なコンポーネント

### 2.1 データ構造定義 (`drumTrackDataStructure.js`)

```javascript
// ドラム楽器の定義
export const DRUM_INSTRUMENTS = [
  { id: 'kick', name: 'Kick', icon: '🥁', color: '#EF4444', pitch: 36, velocity: 0.8, channel: 9 },
  { id: 'snare', name: 'Snare', icon: '🥁', color: '#F59E0B', pitch: 38, velocity: 0.7, channel: 9 },
  // ... その他の楽器
];

// デフォルト設定
export const DEFAULT_DRUM_SETTINGS = {
  gridSize: { rows: 8, columns: 16 },
  tempo: 120,
  timeSignature: '4/4',
  swing: 0,
  quantization: 16,
  loopLength: 4,
  metronomeEnabled: false,
  loopEnabled: false
};
```

### 2.2 ドラムデータ構造

```javascript
const createDrumData = (trackId, pattern = null) => ({
  // 基本情報
  trackId,
  patternId: drumPattern.id,
  patternName: drumPattern.name,
  
  // グリッドデータ
  grid: drumPattern.grid,
  instruments: drumPattern.instruments,
  
  // タイミング設定
  tempo: drumPattern.tempo,
  timeSignature: drumPattern.timeSignature,
  swing: DEFAULT_DRUM_SETTINGS.swing,
  quantization: DEFAULT_DRUM_SETTINGS.quantization,
  loopLength: DEFAULT_DRUM_SETTINGS.loopLength,
  
  // 再生設定
  metronomeEnabled: DEFAULT_DRUM_SETTINGS.metronomeEnabled,
  loopEnabled: DEFAULT_DRUM_SETTINGS.loopEnabled,
  
  // MIDI互換データ（他のコンポーネントとの連携用）
  midiData: {
    notes: [], // グリッドから生成されるMIDIノート
    tempo: drumPattern.tempo,
    timeSignature: drumPattern.timeSignature,
    trackId: trackId,
    lastModified: new Date().toISOString(),
    metadata: {
      created: new Date().toISOString(),
      modified: new Date().toISOString(),
      version: '1.0.0'
    },
    settings: {
      channel: 9, // ドラムチャンネル
      octave: 0,
      transpose: 0,
      velocity: 100
    }
  },
  
  // パターン管理
  patterns: [drumPattern],
  activePatternId: drumPattern.id,
  
  // メタデータ
  lastModified: new Date().toISOString(),
  metadata: {
    created: new Date().toISOString(),
    modified: new Date().toISOString(),
    version: '1.0.0',
    type: 'drum'
  }
});
```

### 2.3 ドラムトラックマネージャー (`drumTrackManager.js`)

```javascript
class DrumTrackManager {
  constructor() {
    this.drumTracks = new Map(); // trackId -> drumData
    this.patterns = new Map(); // patternId -> pattern
    this.activeTracks = new Set(); // アクティブなトラックID
    this.eventListeners = new Map(); // イベントリスナー
  }
  
  // 主要なメソッド
  createDrumTrack(trackId, presetName = null)
  getDrumTrack(trackId)
  updateDrumTrack(trackId, updates)
  deleteDrumTrack(trackId)
  generateMidiNotes(trackId)
  applyPresetPattern(trackId, presetName)
}
```

## 3. 使用方法

### 3.1 基本的な使用例

```javascript
import drumTrackManager from './utils/drumTrackManager.js';
import { createDrumData, createDrumDataFromPreset } from './utils/drumTrackDataStructure.js';

// ドラムトラックの作成
const trackId = 'drum-track-1';
const drumData = drumTrackManager.createDrumTrack(trackId);

// プリセットパターンの適用
drumTrackManager.applyPresetPattern(trackId, 'basic_rock');

// グリッドの更新
drumTrackManager.updateGrid(trackId, newGrid);

// MIDIノートの生成
const midiNotes = drumTrackManager.generateMidiNotes(trackId);
```

### 3.2 App.jsxでの統合

```javascript
// ドラムトラックの作成
if (trackType === TRACK_TYPES.DRUMS) {
  const initialDrumData = createDrumData(newTrack.id);
  
  // ドラムトラックマネージャーに登録
  drumTrackManager.createDrumTrack(newTrack.id);
  
  // プロジェクトマネージャーにも設定
  projectManager.updateTrackDrumData(newTrack.id, initialDrumData);
}

// ドラムデータの更新
const updateTrackDrumData = useCallback((trackId, drumData, keepInArrangement = false) => {
  // ドラムトラックマネージャーを更新
  drumTrackManager.updateDrumTrack(trackId, drumData);
  
  if (projectManager.updateTrackDrumData(trackId, drumData)) {
    // 状態更新処理
  }
}, [projectManager, updateProjectState, activeTab]);
```

### 3.3 DrumTrackコンポーネントでの使用

```javascript
// 初期化処理
useEffect(() => {
  if (trackId && isActive) {
    // ドラムトラックマネージャーからデータを取得または作成
    let trackData = drumTrackManager.getDrumTrack(trackId);
    
    if (!trackData) {
      trackData = drumTrackManager.createDrumTrack(trackId);
    }
    
    // 状態の初期化
    if (!state.isInitialized) {
      state.setGrid(trackData.grid);
      state.setInstruments(trackData.instruments);
      state.setTempo(trackData.tempo);
      state.setTimeSignature(trackData.timeSignature);
      state.setIsInitialized(true);
    }
  }
}, [trackId, isActive, state]);

// グリッドセルのトグル処理
const handleCellToggle = useCallback((rowIndex, colIndex) => {
  const newGrid = state.grid.map((row, r) => 
    r === rowIndex ? row.map((cell, c) => c === colIndex ? !cell : cell) : row
  );
  
  state.setGrid(newGrid);
  
  // ドラムトラックマネージャーを更新
  const updatedData = updateDrumData(
    drumTrackManager.getDrumTrack(trackId) || createDrumData(trackId),
    {
      grid: newGrid,
      instruments: state.instruments,
      tempo: state.tempo,
      timeSignature: state.timeSignature
    }
  );
  
  drumTrackManager.updateDrumTrack(trackId, updatedData);
  
  // 親コンポーネントに更新を通知
  if (onDrumDataUpdate) {
    onDrumDataUpdate(updatedData);
  }
}, [trackId, state.isInitialized, state.grid, state.instruments, state.tempo, state.timeSignature, onDrumDataUpdate]);
```

## 4. プリセットパターン

### 4.1 利用可能なプリセット

```javascript
export const PRESET_PATTERNS = {
  basic_rock: {
    name: 'Basic Rock',
    grid: [
      [true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false], // Kick
      [false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false], // Snare
      [true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true], // Hi-Hat
      // ... その他の楽器
    ]
  },
  basic_jazz: {
    name: 'Basic Jazz',
    // ... ジャズパターン
  },
  basic_funk: {
    name: 'Basic Funk',
    // ... ファンクパターン
  }
};
```

### 4.2 プリセットの適用

```javascript
// プリセットパターンを適用
drumTrackManager.applyPresetPattern(trackId, 'basic_rock');

// プリセットからドラムデータを作成
const drumData = createDrumDataFromPreset(trackId, 'basic_jazz');
```

## 5. イベントシステム

### 5.1 利用可能なイベント

```javascript
// イベントリスナーの追加
drumTrackManager.on('trackCreated', (data) => {
  console.log('Drum track created:', data.trackId);
});

drumTrackManager.on('trackUpdated', (data) => {
  console.log('Drum track updated:', data.trackId, data.updates);
});

drumTrackManager.on('trackDeleted', (data) => {
  console.log('Drum track deleted:', data.trackId);
});

drumTrackManager.on('trackActiveChanged', (data) => {
  console.log('Drum track active changed:', data.trackId, data.active);
});
```

### 5.2 イベントの使用例

```javascript
// コンポーネントでの使用
useEffect(() => {
  const handleTrackUpdate = (data) => {
    if (data.trackId === trackId) {
      // トラックが更新された時の処理
      setForceRerender(prev => prev + 1);
    }
  };
  
  drumTrackManager.on('trackUpdated', handleTrackUpdate);
  
  return () => {
    drumTrackManager.off('trackUpdated', handleTrackUpdate);
  };
}, [trackId]);
```

## 6. データ変換機能

### 6.1 グリッドからMIDIノートへの変換

```javascript
const notes = generateMidiNotesFromGrid(
  grid,
  instruments,
  tempo,
  timeSignature
);
```

### 6.2 MIDIノートからグリッドへの変換

```javascript
const grid = generateGridFromMidiNotes(
  notes,
  instruments,
  gridSize
);
```

## 7. テスト

### 7.1 テストの実行

```javascript
import { runAllDrumTrackTests } from './utils/testDrumTrackDataStructure.js';

// 全テストの実行
runAllDrumTrackTests();

// 個別テストの実行
testDrumTrackDataStructure();
testDrumTrackPerformance();
```

### 7.2 ブラウザでのテスト

```javascript
// ブラウザのコンソールで実行
window.runAllDrumTrackTests();
```

## 8. パフォーマンス最適化

### 8.1 データ更新の最適化

- バッチ更新によるパフォーマンス向上
- 不要な再レンダリングの防止
- メモリ使用量の最適化

### 8.2 推奨事項

- 大量のドラムトラックを扱う場合は、仮想化を検討
- イベントリスナーの適切なクリーンアップ
- 定期的なメモリリークチェック

## 9. 今後の拡張予定

### 9.1 機能拡張

- より多くのプリセットパターン
- カスタムパターンの保存・読み込み
- リアルタイムコラボレーション機能

### 9.2 パフォーマンス改善

- Web Workers を使用したバックグラウンド処理
- より効率的なデータ構造
- キャッシュ機能の強化

## 10. トラブルシューティング

### 10.1 よくある問題

1. **ドラムトラックが作成されない**
   - trackIdが正しく設定されているか確認
   - drumTrackManagerが正しくインポートされているか確認

2. **グリッドが更新されない**
   - イベントリスナーが正しく設定されているか確認
   - 状態管理が正しく動作しているか確認

3. **MIDIノートが生成されない**
   - グリッドデータが正しい形式か確認
   - 楽器設定が正しく設定されているか確認

### 10.2 デバッグ方法

```javascript
// デバッグ情報の出力
console.log('Drum track data:', drumTrackManager.getDrumTrack(trackId));
console.log('All drum tracks:', drumTrackManager.getAllDrumTracks());
console.log('Manager stats:', drumTrackManager.getStats());
```

このドキュメントを参考に、新しいドラムトラックデータ構造を活用してください。 